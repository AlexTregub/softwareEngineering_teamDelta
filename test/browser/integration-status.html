<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Controller Integration Status</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .test-section { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .status { font-weight: bold; margin: 10px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .results { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        pre { margin: 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 Controller Integration Status Check</h1>
        
        <div class="test-section info">
            <h3>📋 System Status</h3>
            <div id="system-status">Checking system status...</div>
        </div>

        <div class="test-section">
            <h3>🧪 Integration Tests</h3>
            <button onclick="runIntegrationTest()">Run Integration Test</button>
            <button onclick="runSpeedTest()">Run Speed Test</button>
            <button onclick="runFullDiagnostics()">Full Diagnostics</button>
            <div class="results" id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>🔍 Class Availability</h3>
            <div id="class-status"></div>
        </div>

        <div class="test-section">
            <h3>⚠️ Known Issues</h3>
            <div id="issues"></div>
        </div>
    </div>

    <script>
        // Global variables for test results
        let systemReady = false;
        
        // Capture errors
        const errors = [];
        window.addEventListener('error', (e) => {
            errors.push(`${e.message} at ${e.filename}:${e.lineno}`);
        });

        function log(elementId, message, className = '') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            if (className) div.className = className;
            div.innerHTML = message;
            element.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, '')); // Log without HTML tags
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '';

            // Check if all required classes are available
            const requiredClasses = [
                'ant', 'MovementController', 'TaskManager', 'RenderController', 
                'AntStateMachine', 'StatsContainer', 'Sprite2D'
            ];

            let allAvailable = true;
            requiredClasses.forEach(className => {
                const available = typeof window[className] !== 'undefined';
                if (!available) allAvailable = false;
                
                const status = available ? '✅' : '❌';
                log('system-status', `${status} ${className}: ${available ? 'Available' : 'Missing'}`, 
                    available ? 'success' : 'error');
            });

            systemReady = allAvailable;
            
            if (allAvailable) {
                log('system-status', '<br><strong>🎉 System Ready!</strong>', 'success');
            } else {
                log('system-status', '<br><strong>⚠️ System Not Ready - Missing Classes</strong>', 'error');
            }
        }

        function runIntegrationTest() {
            clearResults();
            log('test-results', '<strong>🧪 Running Controller Integration Test...</strong>', 'info');
            
            if (!systemReady) {
                log('test-results', '❌ System not ready - run system check first', 'error');
                return;
            }

            try {
                // Check if the global integration test function exists
                if (typeof runControllerIntegrationTest === 'function') {
                    log('test-results', '✅ Found global integration test function', 'success');
                    const result = runControllerIntegrationTest();
                    log('test-results', `📊 Test Result: ${JSON.stringify(result)}`, 'info');
                } else {
                    // Run our own integration test
                    log('test-results', '🔄 Running built-in integration test...', 'info');
                    runBuiltInIntegrationTest();
                }
            } catch (error) {
                log('test-results', `❌ Integration test failed: ${error.message}`, 'error');
                log('test-results', `Stack: ${error.stack}`, 'error');
            }
        }

        function runBuiltInIntegrationTest() {
            let passed = 0;
            let failed = 0;
            
            const tests = [
                {
                    name: "Ant Creation",
                    test: () => {
                        const testAnt = new ant(50, 60, 20, 20, 45, 0);
                        if (!testAnt) throw new Error("Ant creation failed");
                        return testAnt;
                    }
                },
                {
                    name: "MovementController Available",
                    test: (ant) => {
                        if (!ant._movementController) throw new Error("MovementController not created");
                        return ant._movementController;
                    }
                },
                {
                    name: "TaskManager Available", 
                    test: (ant) => {
                        if (!ant._taskManager) throw new Error("TaskManager not created");
                        return ant._taskManager;
                    }
                },
                {
                    name: "RenderController Available",
                    test: (ant) => {
                        if (!ant._renderController) throw new Error("RenderController not created");
                        return ant._renderController;
                    }
                },
                {
                    name: "Movement Speed Configuration",
                    test: (ant) => {
                        if (ant._movementController.movementSpeed !== 45) {
                            throw new Error(`Expected speed 45, got ${ant._movementController.movementSpeed}`);
                        }
                        return ant._movementController.movementSpeed;
                    }
                },
                {
                    name: "Movement Delegation",
                    test: (ant) => {
                        const result = ant.moveToLocation(100, 150);
                        if (!result) throw new Error("Movement delegation failed");
                        return result;
                    }
                },
                {
                    name: "State Machine Integration",
                    test: (ant) => {
                        if (!ant.stateMachine) throw new Error("StateMachine not available");
                        if (typeof ant.isIdle !== 'function') throw new Error("State query methods not available");
                        return ant.stateMachine.primaryState;
                    }
                },
                {
                    name: "Task Manager Queue",
                    test: (ant) => {
                        ant.startGathering();
                        if (!ant._taskManager.hasPendingTasks()) throw new Error("Task not added to queue");
                        return ant._taskManager;
                    }
                },
                {
                    name: "Property Access",
                    test: (ant) => {
                        const isMoving = ant.isMoving;
                        ant.isSelected = true;
                        if (ant.isSelected !== true) throw new Error("Property setter failed");
                        return isMoving;
                    }
                },
                {
                    name: "Controller Update Cycle",
                    test: (ant) => {
                        ant.update(); // Should not throw
                        return true;
                    }
                }
            ];

            let testAnt = null;
            
            tests.forEach((test, index) => {
                try {
                    const result = test.test(index === 0 ? undefined : testAnt);
                    if (index === 0) testAnt = result; // Store ant for other tests
                    
                    log('test-results', `✅ ${test.name}`, 'success');
                    passed++;
                } catch (error) {
                    log('test-results', `❌ ${test.name}: ${error.message}`, 'error');
                    failed++;
                }
            });

            log('test-results', `<br><strong>📊 Integration Test Results: ${passed} passed, ${failed} failed</strong>`, 
                failed === 0 ? 'success' : 'error');
            
            if (failed === 0) {
                log('test-results', '🎉 All controller integrations working perfectly!', 'success');
            }
        }

        function runSpeedTest() {
            clearResults();
            log('test-results', '<strong>⚡ Running Speed Configuration Test...</strong>', 'info');
            
            try {
                const testAnt = new ant(0, 0, 20, 20, 75, 0);
                
                // Test getter
                const speed = testAnt._movementController.movementSpeed;
                log('test-results', `📊 Movement Speed Getter: ${speed}`, 
                    speed === 75 ? 'success' : 'error');
                
                // Test setter
                testAnt._movementController.movementSpeed = 100;
                const newSpeed = testAnt._movementController.movementSpeed;
                log('test-results', `📊 Movement Speed Setter: ${newSpeed}`, 
                    newSpeed === 100 ? 'success' : 'error');
                
                log('test-results', '✅ Speed configuration test completed', 'success');
                
            } catch (error) {
                log('test-results', `❌ Speed test failed: ${error.message}`, 'error');
            }
        }

        function runFullDiagnostics() {
            clearResults();
            log('test-results', '<strong>🔍 Full System Diagnostics</strong>', 'info');
            
            // Check errors
            if (errors.length > 0) {
                log('test-results', '<br><strong>Captured Errors:</strong>', 'error');
                errors.forEach(error => log('test-results', `• ${error}`, 'error'));
            } else {
                log('test-results', '✅ No JavaScript errors detected', 'success');
            }
            
            // Check controller classes specifically
            log('test-results', '<br><strong>Controller Class Details:</strong>', 'info');
            
            ['MovementController', 'TaskManager', 'RenderController'].forEach(className => {
                try {
                    const ClassConstructor = window[className];
                    if (ClassConstructor) {
                        const instance = new ClassConstructor({ posX: 0, posY: 0 }); // Mock entity
                        log('test-results', `✅ ${className}: Can instantiate`, 'success');
                        log('test-results', `   Methods: ${Object.getOwnPropertyNames(Object.getPrototypeOf(instance)).join(', ')}`, 'info');
                    } else {
                        log('test-results', `❌ ${className}: Not available`, 'error');
                    }
                } catch (error) {
                    log('test-results', `❌ ${className}: Error - ${error.message}`, 'error');
                }
            });
            
            log('test-results', '<br>✅ Diagnostics completed', 'success');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkSystemStatus();
                
                // Show any errors that occurred during loading
                const issuesDiv = document.getElementById('issues');
                if (errors.length > 0) {
                    errors.forEach(error => {
                        log('issues', `⚠️ ${error}`, 'warning');
                    });
                } else {
                    log('issues', '✅ No loading errors detected', 'success');
                }
            }, 500); // Wait for all scripts to load
        });
    </script>

    <!-- Load all required scripts -->
    <script src="libraries/p5.min.js"></script>
    <script src="Classes/entities/sprite2d.js"></script>
    <script src="Classes/entities/StatsContainer.js"></script>
    <script src="Classes/ants/antStateMachine.js"></script>
    <script src="Classes/systems/ResourceManager.js"></script>
    <script src="Classes/managers/GameStateManager.js"></script>
    <script src="Classes/systems/MovementController.js"></script>
    <script src="Classes/systems/TaskManager.js"></script>
    <script src="Classes/systems/RenderController.js"></script>
    <script src="Classes/ants/ants.js"></script>
    <script src="Classes/ants/Job.js"></script>
</body>
</html>