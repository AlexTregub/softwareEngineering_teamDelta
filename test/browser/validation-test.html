<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Controller Validation Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß Controller Property Validation Test</h1>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Capture all errors
        window.addEventListener('error', function(e) {
            log(`‚ùå JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            log('üîÑ Starting controller validation test...', 'info');
            
            setTimeout(function() {
                try {
                    // Test 1: Check classes are available
                    if (typeof MovementController === 'undefined') {
                        log('‚ùå MovementController not available', 'error');
                        return;
                    }
                    if (typeof TaskManager === 'undefined') {
                        log('‚ùå TaskManager not available', 'error');
                        return;
                    }
                    if (typeof RenderController === 'undefined') {
                        log('‚ùå RenderController not available', 'error');
                        return;
                    }
                    log('‚úÖ All controller classes available', 'success');
                    
                    // Test 2: Create mock entity and controllers
                    const mockEntity = {
                        posX: 100, posY: 100, movementSpeed: 30,
                        _stateMachine: { 
                            canPerformAction: () => true,
                            setPrimaryState: () => {},
                            isPrimaryState: () => false
                        },
                        _sprite: { setPosition: () => {} },
                        _stats: { position: { statValue: { x: 100, y: 100 } } }
                    };
                    
                    // Test MovementController
                    const movement = new MovementController(mockEntity);
                    log('‚úÖ MovementController created successfully', 'success');
                    
                    // Test property access
                    if (movement._entity && movement._isMoving !== undefined && movement._taskQueue === undefined) {
                        log('‚úÖ MovementController properties using correct naming', 'success');
                    } else {
                        log('‚ö†Ô∏è MovementController property naming might be inconsistent', 'warning');
                    }
                    
                    // Test TaskManager
                    const taskManager = new TaskManager(mockEntity);
                    log('‚úÖ TaskManager created successfully', 'success');
                    
                    // Test TaskManager properties
                    if (taskManager._taskQueue && Array.isArray(taskManager._taskQueue)) {
                        log('‚úÖ TaskManager._taskQueue property accessible', 'success');
                    } else {
                        log('‚ùå TaskManager._taskQueue not accessible or not array', 'error');
                    }
                    
                    // Test adding task
                    taskManager.addTask({
                        id: 'test-task',
                        type: 'MOVE',
                        x: 200, y: 200,
                        priority: 1
                    });
                    
                    if (taskManager._taskQueue.length > 0) {
                        log('‚úÖ Task added to TaskManager successfully', 'success');
                    } else {
                        log('‚ùå Failed to add task to TaskManager', 'error');
                    }
                    
                    // Test RenderController
                    const renderController = new RenderController(mockEntity);
                    log('‚úÖ RenderController created successfully', 'success');
                    
                    // Test RenderController properties
                    if (renderController._entity && renderController._effects && Array.isArray(renderController._effects)) {
                        log('‚úÖ RenderController properties using correct naming', 'success');
                    } else {
                        log('‚ö†Ô∏è RenderController property naming might be inconsistent', 'warning');
                    }
                    
                    // Test integrated ant creation
                    if (typeof ant !== 'undefined') {
                        const testAnt = new ant(100, 100, 20, 20, 30, 0);
                        
                        if (testAnt._movementController && testAnt._taskManager && testAnt._renderController) {
                            log('‚úÖ Ant creates with all controllers', 'success');
                            
                            // Test task delegation
                            testAnt.addCommand({
                                type: 'MOVE',
                                x: 200, y: 200,
                                priority: 1
                            });
                            
                            if (testAnt._taskManager._taskQueue.length > 0) {
                                log('‚úÖ Command successfully delegated to TaskManager', 'success');
                            } else {
                                log('‚ùå Command delegation to TaskManager failed', 'error');
                            }
                            
                            // Test movement delegation
                            const moveResult = testAnt.moveToLocation(150, 150);
                            if (moveResult && testAnt.isMoving) {
                                log('‚úÖ Movement successfully delegated to MovementController', 'success');
                            } else {
                                log('‚ùå Movement delegation failed', 'error');
                            }
                            
                        } else {
                            log('‚ùå Ant missing one or more controllers', 'error');
                        }
                    } else {
                        log('‚ö†Ô∏è Ant class not available for testing', 'warning');
                    }
                    
                    log('‚úÖ Controller validation test completed successfully', 'success');
                    
                } catch (error) {
                    log(`‚ùå Validation test error: ${error.message}`, 'error');
                    log(`Stack: ${error.stack}`, 'error');
                }
            }, 200); // Wait for all scripts to load
        });
    </script>

    <!-- Load scripts in correct order -->
    <script src="libraries/p5.min.js"></script>
    <script src="Classes/entities/sprite2d.js"></script>
    <script src="Classes/entities/StatsContainer.js"></script>
    <script src="Classes/ants/antStateMachine.js"></script>
    <script src="Classes/systems/ResourceManager.js"></script>
    <script src="Classes/managers/GameStateManager.js"></script>
    <script src="Classes/systems/MovementController.js"></script>
    <script src="Classes/systems/TaskManager.js"></script>
    <script src="Classes/systems/RenderController.js"></script>
    <script src="Classes/ants/ants.js"></script>
</body>
</html>