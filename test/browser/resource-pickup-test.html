<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Resource Pickup Test</title>
  <style>body{font-family:Arial,sans-serif;padding:20px}</style>
</head>
<body>
  <h1>Resource Pickup Browser Test</h1>
  <div id="results"></div>

  <!-- Load game scripts in a minimal order needed for test -->
  <script src="libraries/p5.min.js"></script>
  <script src="Classes/resource.js"></script>
  <script src="Classes/resources.js"></script>
  <script src="Classes/containers/Entity.js"></script>
  <script src="Classes/managers/ResourceManager.js"></script>
  <script src="Classes/ants/ants.js"></script>

  <script>
    // Auto-run pickup test
    (function(){
      function log(msg){ const el = document.getElementById('results'); el.innerHTML += '<pre>'+msg+'</pre>'; console.log(msg); }

      function waitFor(fn, cb, timeout=2000){ const start=Date.now(); (function p(){ if(fn()) return cb(); if(Date.now()-start>timeout) return log('TIMEOUT waiting'); setTimeout(p,50) })(); }

      waitFor(()=> typeof Resource !== 'undefined' && typeof ResourceManager !== 'undefined' && typeof Ant !== 'undefined', ()=>{
        try{
          // Prepare global list
          window.g_resourceList = { _list: [], getResourceList(){ return this._list } };

          // create ant and resource near each other
          const ant = new Ant(100,100,20,20,30,0);
          if (typeof ants !== 'undefined') ants.push(ant);

          const res = new Resource(105,105,16,16,'leaf');
          g_resourceList.getResourceList().push(res);

          // Hook into resource.pickUp to detect
          let picked = false;
          const origPick = res.pickUp;
          res.pickUp = function(a){ picked = true; origPick.call(this,a); }

          // create manager on ant and update
          ant._resourceManager = new ResourceManager(ant, 2, 25);
          ant._resourceManager.update();

          setTimeout(()=>{
            const remaining = g_resourceList.getResourceList().length;
            const carried = ant._resourceManager.getCurrentLoad();
            const ok = remaining === 0 && carried === 1 && picked === true;
            log('remaining=' + remaining + ' carried=' + carried + ' picked=' + picked);

            // send beacon
            const payload = encodeURIComponent(JSON.stringify({ pickup: ok ? 'PASS' : 'FAIL', remaining, carried, picked }));
            const img = new Image(); img.src = '/__test_report?d='+payload;

            log(ok ? 'TEST PASS' : 'TEST FAIL');
          }, 200);

        }catch(e){ log('ERROR: '+e.message); }
      });
    })();
  </script>
</body>
</html>