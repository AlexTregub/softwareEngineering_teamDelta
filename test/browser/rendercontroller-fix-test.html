<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>RenderController Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .test-section { margin: 20px 0; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .results { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        pre { margin: 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß RenderController Fix Test</h1>
        
        <div class="test-section info">
            <h3>üìã Fix Information</h3>
            <p><strong>Issue:</strong> RenderController trying to call p5.js functions (strokeWeight, stroke, etc.) that weren't accessible in class context</p>
            <p><strong>Solution:</strong> Added _safeRender() wrapper method to check p5.js function availability before calling them</p>
            <p><strong>Affected Methods:</strong> renderOutlineHighlight, renderFallbackEntity, renderMovementIndicators, renderStateIndicators, renderDebugInfo</p>
        </div>

        <div class="test-section">
            <h3>üß™ Test RenderController</h3>
            <button onclick="testRenderController()">Test RenderController Creation</button>
            <button onclick="testAntWithRenderer()">Test Ant with RenderController</button>
            <button onclick="testRenderingMethods()">Test Rendering Methods</button>
            <div class="results" id="test-results"></div>
        </div>

        <div class="test-section">
            <h3>üìä Error Status</h3>
            <div id="error-status"></div>
        </div>
    </div>

    <script>
        // Global variables for test results
        const errors = [];
        
        // Capture errors
        window.addEventListener('error', (e) => {
            errors.push(`${e.message} at ${e.filename}:${e.lineno}`);
            updateErrorStatus();
        });

        function log(message, className = '') {
            const element = document.getElementById('test-results');
            const div = document.createElement('div');
            if (className) div.className = className;
            div.innerHTML = message;
            element.appendChild(div);
            console.log(message.replace(/<[^>]*>/g, '')); // Log without HTML tags
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        function updateErrorStatus() {
            const statusDiv = document.getElementById('error-status');
            statusDiv.innerHTML = '';
            
            if (errors.length === 0) {
                const div = document.createElement('div');
                div.className = 'success';
                div.innerHTML = '‚úÖ No errors detected - RenderController fix appears to be working!';
                statusDiv.appendChild(div);
            } else {
                const div = document.createElement('div');
                div.className = 'error';
                div.innerHTML = `‚ùå ${errors.length} error(s) detected:<br>`;
                errors.forEach(error => {
                    div.innerHTML += `‚Ä¢ ${error}<br>`;
                });
                statusDiv.appendChild(div);
            }
        }

        function testRenderController() {
            clearResults();
            log('<strong>üîß Testing RenderController creation...</strong>', 'info');
            
            try {
                // Check if RenderController is available
                if (typeof RenderController === 'undefined') {
                    log('‚ùå RenderController class not available', 'error');
                    return;
                }
                
                log('‚úÖ RenderController class is available', 'success');
                
                // Create a mock entity
                const mockEntity = {
                    _sprite: { render: () => {} },
                    _stateMachine: { primaryState: 'IDLE' },
                    _antIndex: 1,
                    posX: 100,
                    posY: 100,
                    sizeX: 20,
                    sizeY: 20
                };
                
                // Create RenderController
                const renderController = new RenderController(mockEntity);
                log('‚úÖ RenderController created successfully', 'success');
                
                // Test _isP5Available method
                const p5Available = renderController._isP5Available();
                log(`üìä p5.js functions available: ${p5Available ? 'YES' : 'NO'}`, 
                    p5Available ? 'success' : 'warning');
                
                // Test _safeRender method
                let safeRenderWorked = false;
                renderController._safeRender(() => {
                    safeRenderWorked = true;
                });
                
                if (safeRenderWorked || !renderController._isP5Available()) {
                    log('‚úÖ _safeRender method working correctly', 'success');
                } else {
                    log('‚ö†Ô∏è _safeRender method behavior unclear', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Error testing RenderController: ${error.message}`, 'error');
            }
        }

        function testAntWithRenderer() {
            clearResults();
            log('<strong>üêú Testing Ant creation with RenderController...</strong>', 'info');
            
            try {
                if (typeof ant === 'undefined') {
                    log('‚ùå Ant class not available', 'error');
                    return;
                }
                
                // Create test ant
                const testAnt = new ant(150, 150, 25, 25, 40, 0);
                log('‚úÖ Ant created successfully', 'success');
                
                // Check if RenderController was created
                if (testAnt._renderController) {
                    log('‚úÖ Ant has RenderController attached', 'success');
                    
                    // Test that the RenderController has the new safety methods
                    if (typeof testAnt._renderController._safeRender === 'function') {
                        log('‚úÖ RenderController has _safeRender method', 'success');
                    } else {
                        log('‚ùå RenderController missing _safeRender method', 'error');
                    }
                    
                    if (typeof testAnt._renderController._isP5Available === 'function') {
                        log('‚úÖ RenderController has _isP5Available method', 'success');
                    } else {
                        log('‚ùå RenderController missing _isP5Available method', 'error');
                    }
                    
                } else {
                    log('‚ö†Ô∏è Ant does not have RenderController (fallback mode)', 'warning');
                }
                
                // Test the render method (this is where the original error occurred)
                log('üé® Testing ant.render() method...', 'info');
                testAnt.render();
                log('‚úÖ ant.render() executed without throwing errors', 'success');
                
            } catch (error) {
                log(`‚ùå Error testing ant with renderer: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
            }
        }

        function testRenderingMethods() {
            clearResults();
            log('<strong>üé® Testing individual rendering methods...</strong>', 'info');
            
            try {
                // Create test ant with RenderController
                const testAnt = new ant(200, 200, 30, 30, 35, 0);
                
                if (!testAnt._renderController) {
                    log('‚ö†Ô∏è No RenderController available for detailed testing', 'warning');
                    return;
                }
                
                const rc = testAnt._renderController;
                
                // Test highlighting methods
                log('üåü Testing highlighting methods...', 'info');
                
                rc.highlightSelected();
                rc.render();
                log('‚úÖ Selected highlighting test passed', 'success');
                
                rc.highlightHover();
                rc.render();
                log('‚úÖ Hover highlighting test passed', 'success');
                
                rc.clearHighlight();
                rc.render();
                log('‚úÖ Clear highlighting test passed', 'success');
                
                // Test movement indication
                log('üö∂ Testing movement indicators...', 'info');
                testAnt.moveToLocation(250, 250);
                rc.render();
                log('‚úÖ Movement indicator test passed', 'success');
                
                // Test debug mode
                log('üêõ Testing debug rendering...', 'info');
                rc._debugMode = true;
                rc.render();
                rc._debugMode = false;
                log('‚úÖ Debug rendering test passed', 'success');
                
                log('<br><strong>üéâ All rendering method tests passed!</strong>', 'success');
                
            } catch (error) {
                log(`‚ùå Error testing rendering methods: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
            }
        }

        // Initialize error status on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                updateErrorStatus();
            }, 1000); // Wait for scripts to load
        });
    </script>

    <!-- Load all required scripts -->
    <script src="libraries/p5.min.js"></script>
    <script src="Classes/entities/sprite2d.js"></script>
    <script src="Classes/entities/stats.js"></script>
    <script src="Classes/ants/antStateMachine.js"></script>
    <script src="Classes/systems/ResourceManager.js"></script>
    <script src="Classes/managers/GameStateManager.js"></script>
    <script src="Classes/systems/MovementController.js"></script>
    <script src="Classes/systems/TaskManager.js"></script>
    <script src="Classes/systems/RenderController.js"></script>
    <script src="Classes/ants/ants.js"></script>
    <script src="Classes/ants/species.js"></script>
</body>
</html>