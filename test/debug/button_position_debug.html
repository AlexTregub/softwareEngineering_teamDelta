<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button Position Debug Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: white;
        }
        
        #debug-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            font-size: 12px;
            z-index: 10000;
        }
        
        #debug-log {
            background: rgba(0, 0, 0, 0.8);
            color: lime;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
        
        .debug-section {
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        canvas {
            border: 2px solid #34495e;
            background: radial-gradient(circle, #1a4d2e, #1a4d4d);
        }
    </style>
</head>
<body>
    <h1>Button Position Debug Test</h1>
    <p>Isolated test for Universal Button System positioning</p>
    
    <div id="debug-info">
        <h3>Debug Information</h3>
        <div class="debug-section">
            <strong>System Status:</strong>
            <div id="system-status">Loading...</div>
        </div>
        <div class="debug-section">
            <strong>Console Output:</strong>
            <div id="debug-log"></div>
        </div>
    </div>
    
    <!-- Include required libraries and systems -->
    <script src="../libraries/p5.min.js"></script>
    <script src="../Classes/rendering/Button.js"></script>
    <script src="../Classes/rendering/ButtonStyles.js"></script>
    <script src="../Classes/systems/ui/ButtonGroup.js"></script>
    <script src="../Classes/systems/ui/ButtonGroupManager.js"></script>
    <script src="../Classes/systems/ui/GameActionFactory.js"></script>
    
    <script>
        // Debug logging capture
        const debugLog = document.getElementById('debug-log');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function appendDebugLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${type}: ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            appendDebugLog('LOG', args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            appendDebugLog('ERROR', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            appendDebugLog('WARN', args.join(' '));
        };
        
        // Global variables
        let buttonManager;
        let gameActionFactory;
        let testConfig;
        
        // Simplified game state for testing
        window.currentGameState = 'playing';
        window.gameState = 'playing';
        
        // Canvas dimensions
        const CANVAS_WIDTH = 1000;
        const CANVAS_HEIGHT = 600;
        
        // p5.js setup
        function setup() {
            createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
            
            console.log('üöÄ Starting Button Position Debug Test');
            console.log(`üìê Canvas size: ${CANVAS_WIDTH}x${CANVAS_HEIGHT}`);
            
            // Initialize systems
            initializeTestSystem();
        }
        
        // p5.js draw loop
        function draw() {
            background(26, 77, 46, 200); // Semi-transparent green background
            
            // Draw alignment grid
            drawAlignmentGrid();
            
            // Render button groups if ready
            if (buttonManager) {
                try {
                    buttonManager.render();
                } catch (error) {
                    console.error('Render error:', error);
                }
            }
            
            // Update system status display (only once per second)
            if (frameCount % 60 === 0) {
                updateSystemStatus();
            }
        }
        
        // Mouse event handlers
        function mousePressed() {
            if (buttonManager) {
                buttonManager.handleInput(mouseX, mouseY, true);
            }
        }
        
        function mouseReleased() {
            if (buttonManager) {
                buttonManager.handleInput(mouseX, mouseY, false);
            }
        }
        
        function mouseDragged() {
            if (buttonManager) {
                buttonManager.update(mouseX, mouseY, true);
            }
        }
        
        // Initialize the test system
        async function initializeTestSystem() {
            try {
                console.log('üîß Initializing test system...');
                
                // Create action factory
                if (typeof createGameActionFactory === 'function') {
                    gameActionFactory = createGameActionFactory();
                    console.log('‚úÖ GameActionFactory created');
                } else {
                    console.error('‚ùå createGameActionFactory function not found');
                    return;
                }
                
                // Create button manager
                if (typeof ButtonGroupManager !== 'undefined') {
                    buttonManager = new ButtonGroupManager(gameActionFactory);
                    console.log('‚úÖ ButtonGroupManager created');
                } else {
                    console.error('‚ùå ButtonGroupManager class not found');
                    return;
                }
                
                // Load test configuration
                await loadTestConfiguration();
                
            } catch (error) {
                console.error('‚ùå System initialization failed:', error);
            }
        }
        
        // Load test configuration
        async function loadTestConfiguration() {
            try {
                console.log('üìã Loading test configuration...');
                
                // Load the legacy conversions config
                const response = await fetch('../config/button-groups/legacy-conversions.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                testConfig = await response.json();
                console.log('‚úÖ Test configuration loaded:', testConfig);
                
                // Initialize button manager with configuration
                const result = buttonManager.initialize(testConfig.groups);
                console.log('üéØ Initialization result:', result);
                
                // Verify groups were created
                const activeCount = buttonManager.getActiveGroupCount();
                console.log(`üìä Active button groups: ${activeCount}`);
                
                if (activeCount > 0) {
                    // Log details about each group
                    const allGroups = buttonManager.getAllGroups();
                    allGroups.forEach(group => {
                        const pos = group.getPosition();
                        const bounds = group.getBounds();
                        console.log(`üìå Group ${group.getId()}: pos(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)}) bounds(${bounds.width.toFixed(1)}x${bounds.height.toFixed(1)})`);
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Configuration loading failed:', error);
                
                // Create a minimal test configuration as fallback
                createFallbackConfiguration();
            }
        }
        
        // Create fallback configuration for testing
        function createFallbackConfiguration() {
            console.log('üîÑ Creating fallback test configuration...');
            
            const fallbackConfig = [
                {
                    id: 'test-group-1',
                    name: 'Test Group 1',
                    layout: {
                        type: 'horizontal',
                        position: { x: 'left', y: 'top', offsetX: 50, offsetY: 50 },
                        spacing: 10,
                        padding: { top: 10, right: 10, bottom: 10, left: 10 }
                    },
                    appearance: { visible: true, transparency: 1.0 },
                    behavior: { draggable: true },
                    buttons: [
                        {
                            id: 'test-btn-1',
                            text: 'Test 1',
                            size: { width: 80, height: 40 },
                            style: {
                                backgroundColor: '#4CAF50',
                                textColor: 'white',
                                fontSize: 14
                            },
                            action: { type: 'debug', handler: 'test.action1' }
                        }
                    ]
                },
                {
                    id: 'test-group-2',
                    name: 'Test Group 2',
                    layout: {
                        type: 'grid',
                        position: { x: 'right', y: 'center', offsetX: -200, offsetY: 0 },
                        columns: 2,
                        spacing: 8,
                        padding: { top: 15, right: 15, bottom: 15, left: 15 }
                    },
                    appearance: { visible: true, transparency: 1.0 },
                    behavior: { draggable: true },
                    buttons: [
                        {
                            id: 'test-btn-2a',
                            text: '+1',
                            size: { width: 60, height: 35 },
                            style: { backgroundColor: '#2196F3', textColor: 'white', fontSize: 12 },
                            action: { type: 'debug', handler: 'test.action2a' }
                        },
                        {
                            id: 'test-btn-2b',
                            text: '-1',
                            size: { width: 60, height: 35 },
                            style: { backgroundColor: '#f44336', textColor: 'white', fontSize: 12 },
                            action: { type: 'debug', handler: 'test.action2b' }
                        }
                    ]
                }
            ];
            
            try {
                const result = buttonManager.initialize(fallbackConfig);
                console.log('‚úÖ Fallback configuration initialized:', result);
            } catch (error) {
                console.error('‚ùå Fallback configuration failed:', error);
            }
        }
        
        // Draw alignment grid for debugging
        function drawAlignmentGrid() {
            stroke(255, 255, 255, 30);
            strokeWeight(1);
            
            // Vertical lines
            for (let x = 0; x <= width; x += 50) {
                line(x, 0, x, height);
            }
            
            // Horizontal lines
            for (let y = 0; y <= height; y += 50) {
                line(0, y, width, y);
            }
            
            // Center lines
            stroke(255, 255, 0, 100);
            strokeWeight(2);
            line(width / 2, 0, width / 2, height);
            line(0, height / 2, width, height / 2);
            
            // Edge boundaries
            stroke(255, 0, 0, 150);
            strokeWeight(3);
            noFill();
            rect(1, 1, width - 2, height - 2);
        }
        
        // Update system status display
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            
            let status = '';
            
            if (buttonManager) {
                const activeCount = buttonManager.getActiveGroupCount();
                status += `Active Groups: ${activeCount}<br>`;
                
                if (activeCount > 0) {
                    const groups = buttonManager.getAllGroups();
                    groups.forEach(group => {
                        const pos = group.getPosition();
                        const bounds = group.getBounds();
                        status += `${group.getId()}: (${pos.x.toFixed(0)}, ${pos.y.toFixed(0)}) [${bounds.width.toFixed(0)}√ó${bounds.height.toFixed(0)}]<br>`;
                    });
                }
            } else {
                status = 'Button Manager: Not initialized<br>';
            }
            
            status += `Canvas: ${width}√ó${height}<br>`;
            status += `Mouse: (${mouseX}, ${mouseY})<br>`;
            status += `Frame: ${frameCount}`;
            
            statusDiv.innerHTML = status;
        }
    </script>
</body>
</html>