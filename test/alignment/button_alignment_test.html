<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button Group Alignment Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: white;
        }
        
        .test-container {
            position: relative;
            width: 100vw;
            height: 80vh;
            border: 2px solid #34495e;
            background: linear-gradient(45deg, #1a4d2e, #1a4d4d);
            overflow: hidden;
        }
        
        .alignment-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }
        
        .position-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 0, 0.7);
            border-radius: 50%;
            border: 2px solid #fff;
            z-index: 1000;
        }
        
        .position-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1001;
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            font-size: 14px;
        }
        
        .group-info {
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 100;
        }
    </style>
</head>
<body>
    <h1>Button Group Alignment Test</h1>
    <p>Testing the positioning and alignment of Universal Button System groups</p>
    
    <div class="test-container" id="testContainer">
        <div class="alignment-grid"></div>
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <div class="info-panel" id="infoPanel">
        <h3>Button Groups Status</h3>
        <div id="groupStatus">Loading...</div>
    </div>
    
    <!-- Include p5.js and game files -->
    <script src="../libraries/p5.min.js"></script>
    <script src="../Classes/rendering/Button.js"></script>
    <script src="../Classes/rendering/ButtonStyles.js"></script>
    <script src="../Classes/systems/ui/ButtonGroup.js"></script>
    <script src="../Classes/systems/ui/ButtonGroupManager.js"></script>
    <script src="../Classes/systems/ui/GameActionFactory.js"></script>
    
    <script>
        // Global variables
        let buttonManager;
        let gameActionFactory;
        let canvas;
        
        // Canvas dimensions
        const CANVAS_WIDTH = window.innerWidth - 40;
        const CANVAS_HEIGHT = window.innerHeight * 0.8;
        
        // p5.js setup
        function setup() {
            canvas = createCanvas(CANVAS_WIDTH, CANVAS_HEIGHT);
            canvas.parent('testContainer');
            
            // Initialize systems
            initializeButtonSystem();
            
            // Update info panel
            updateInfoPanel();
        }
        
        // p5.js draw loop
        function draw() {
            background(34, 73, 87, 100); // Semi-transparent background
            
            // Draw alignment guides
            drawAlignmentGuides();
            
            // Render button groups
            if (buttonManager) {
                buttonManager.render();
            }
            
            // Draw position markers
            drawPositionMarkers();
        }
        
        // p5.js mouse events
        function mousePressed() {
            if (buttonManager) {
                buttonManager.handleInput(mouseX, mouseY, true);
            }
        }
        
        function mouseReleased() {
            if (buttonManager) {
                buttonManager.handleInput(mouseX, mouseY, false);
            }
        }
        
        function mouseDragged() {
            if (buttonManager) {
                buttonManager.update(mouseX, mouseY, true);
            }
        }
        
        // Initialize the Universal Button System
        function initializeButtonSystem() {
            try {
                console.log('üöÄ Initializing Button System for alignment test');
                
                // Create action factory
                gameActionFactory = new GameActionFactory();
                console.log('‚úÖ GameActionFactory created');
                
                // Create button manager
                buttonManager = new ButtonGroupManager(gameActionFactory);
                console.log('‚úÖ ButtonGroupManager created');
                
                // Load button configurations
                fetch('../config/button-groups/legacy-conversions.json')
                    .then(response => response.json())
                    .then(config => {
                        console.log('üìù Loaded button config:', config);
                        buttonManager.loadFromConfiguration(config);
                        console.log('‚úÖ Button groups loaded');
                        updateInfoPanel();
                    })
                    .catch(error => {
                        console.error('‚ùå Failed to load button config:', error);
                        updateInfoPanel('Error loading configuration');
                    });
                    
            } catch (error) {
                console.error('‚ùå Failed to initialize button system:', error);
                updateInfoPanel('Initialization failed');
            }
        }
        
        // Draw alignment guides
        function drawAlignmentGuides() {
            stroke(255, 255, 255, 50);
            strokeWeight(1);
            
            // Center lines
            line(width / 2, 0, width / 2, height);
            line(0, height / 2, width, height / 2);
            
            // Quarter lines
            line(width / 4, 0, width / 4, height);
            line(3 * width / 4, 0, 3 * width / 4, height);
            line(0, height / 4, width, height / 4);
            line(0, 3 * height / 4, width, 3 * height / 4);
            
            // Edge margins (20px)
            stroke(255, 255, 0, 100);
            noFill();
            rect(20, 20, width - 40, height - 40);
        }
        
        // Draw position markers for expected button positions
        function drawPositionMarkers() {
            if (!buttonManager) return;
            
            fill(255, 255, 0, 150);
            noStroke();
            
            const groups = buttonManager.getAllGroups();
            groups.forEach(group => {
                const pos = group.getPosition();
                const bounds = group.getBounds();
                
                // Draw position marker
                circle(pos.x, pos.y, 10);
                
                // Draw bounds outline
                stroke(255, 255, 0, 100);
                strokeWeight(2);
                noFill();
                rect(bounds.x, bounds.y, bounds.width, bounds.height);
                
                // Label
                fill(255, 255, 255);
                textSize(10);
                text(group.getId(), pos.x + 15, pos.y - 5);
            });
        }
        
        // Update info panel with group status
        function updateInfoPanel(errorMessage = null) {
            const statusDiv = document.getElementById('groupStatus');
            
            if (errorMessage) {
                statusDiv.innerHTML = `<div style="color: #e74c3c;">${errorMessage}</div>`;
                return;
            }
            
            if (!buttonManager) {
                statusDiv.innerHTML = '<div>Initializing...</div>';
                return;
            }
            
            const groups = buttonManager.getAllGroups();
            let html = '';
            
            groups.forEach(group => {
                const pos = group.getPosition();
                const bounds = group.getBounds();
                const buttons = group.buttons || [];
                
                html += `
                    <div class="group-info">
                        <strong>${group.getName()}</strong><br>
                        Position: (${pos.x.toFixed(0)}, ${pos.y.toFixed(0)})<br>
                        Bounds: ${bounds.width.toFixed(0)}√ó${bounds.height.toFixed(0)}<br>
                        Buttons: ${buttons.length}<br>
                        Visible: ${group.isVisible() ? '‚úÖ' : '‚ùå'}
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div>No groups loaded</div>';
            }
            
            statusDiv.innerHTML = html;
        }
        
        // Update info panel periodically
        setInterval(updateInfoPanel, 1000);
        
        // Handle window resize
        function windowResized() {
            const newWidth = window.innerWidth - 40;
            const newHeight = window.innerHeight * 0.8;
            resizeCanvas(newWidth, newHeight);
            
            // Recalculate button positions
            if (buttonManager) {
                const groups = buttonManager.getAllGroups();
                groups.forEach(group => {
                    group.calculatePosition();
                });
            }
        }
    </script>
</body>
</html>